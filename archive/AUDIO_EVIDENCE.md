# Audio Dropout Investigation - Evidence and Analysis

## Investigation Command Results

### 1. GUI Audio Configuration

**Command**: `grep -r "audioBufferSize\|inputBufferSize" include/ src/ --include="*.h" -A2 -B2`

**Result** (include/synthesizer.h):
```cpp
struct Parameters {
    int inputChannelCount = 1;
    int inputBufferSize = 1024;        // DEFAULT value
    int audioBufferSize = 44100;       // DEFAULT value
    float inputSampleRate = 10000;
    float audioSampleRate = 44100;
```

**Result** (src/simulator.cpp):
```cpp
void Simulator::initializeSynthesizer() {
    Synthesizer::Parameters synthParams;
    synthParams.audioBufferSize = 44100;      // GUI overrides default
    synthParams.audioSampleRate = 44100;      // GUI uses 44.1kHz
    synthParams.inputBufferSize = 44100;      // GUI overrides default (KEY!)
```

### 2. CLI Audio Configuration

**Command**: `grep -r "audioBufferSize\|inputBufferSize" src/engine_sim_cli.cpp -A2 -B2`

**Result** (src/engine_sim_cli.cpp):
```cpp
EngineSimConfig config = {};
config.sampleRate = sampleRate;
config.inputBufferSize = 1024;        // Uses bridge default (NOT GUI value!)
config.audioBufferSize = 96000;       // Uses bridge default (NOT GUI value!)
```

### 3. Bridge Default Configuration

**Result** (engine-sim-bridge/src/engine_sim_bridge.cpp):
```cpp
static void setDefaultConfig(EngineSimConfig* config) {
    config->sampleRate = 48000;
    config->inputBufferSize = 1024;    // Bridge default
    config->audioBufferSize = 96000;   // Bridge default (2 seconds @ 48kHz)
```

## The Smoking Gun

### GUI's Explicit Configuration

**File**: engine-sim-bridge/engine-sim/src/simulator.cpp:213-215

```cpp
synthParams.audioBufferSize = 44100;
synthParams.audioSampleRate = 44100;
synthParams.inputBufferSize = 44100;   // <-- GUI sets this to MATCH sample rate
```

The GUI explicitly sets `inputBufferSize = audioSampleRate`, creating a **1:1 ratio**.

### CLI's Implicit Configuration

**File**: src/engine_sim_cli.cpp:592-593

```cpp
config.inputBufferSize = 1024;         // <-- CLI uses bridge default
config.audioBufferSize = 96000;
```

The CLI uses bridge defaults, creating a **1:47 ratio** (1024:48000).

## Impact Analysis

### Buffer Duration Comparison

| Implementation | Samples | Sample Rate | Duration |
|----------------|---------|-------------|----------|
| GUI | 44100 | 44100 Hz | **1000 ms** |
| CLI | 1024 | 48000 Hz | **21.3 ms** |
| Difference | 43x | | **48x shorter** |

### At 60 FPS (16.6ms per frame)

| Implementation | Buffer Duration | Frames in Buffer | Margin per Frame |
|----------------|-----------------|------------------|------------------|
| GUI | 1000 ms | 60 frames | 983.4 ms |
| CLI | 21.3 ms | 1.3 frames | **4.7 ms** |

The CLI has only **4.7ms of margin** for timing variations vs the GUI's **983.4ms**.

### Why 10% Throttle is Problematic

1. **Low RPM** = fewer audio events per second
2. **Fewer events** = less audio generated by audio thread
3. **Small buffer** = drains faster
4. **Timing variance** = any delay > 4.7ms causes underrun

## Test Evidence

### Test Run at 10% Throttle

**Command**: `./build/engine-sim-cli --default-engine --load 10 --duration 10 --play 2>&1`

**Output**: No underrun messages printed

**Analysis**:
- Underrun reporting is throttled (once per second - see bridge line 475)
- Silent underruns (filled with silence) don't generate warnings
- User reports "occasional" dropouts, not continuous ones
- This is consistent with the small buffer theory

### GUI's maxWrite Calculation

**File**: engine-sim-bridge/engine-sim/src/engine_sim_application.cpp:256-258

```cpp
SampleOffset targetWritePosition =
    m_audioBuffer.getBufferIndex(safeWritePosition, (int)(44100 * 0.1));
SampleOffset maxWrite = m_audioBuffer.offsetDelta(writePosition, targetWritePosition);
```

The GUI requests up to **4410 samples** (100ms) per frame.

This is **4.3x larger** than the CLI's entire input buffer (1024 samples).

## Stereo Conversion Bug Evidence

### EngineSimRender (INCORRECT)

**File**: engine-sim-bridge/src/engine_sim_bridge.cpp:520

```cpp
for (int i = 0; i < samplesRead * 2; ++i) {
    buffer[i] = static_cast<float>(ctx->audioConversionBuffer[i]) * scale;
}
```

**Problem**: Assumes `audioConversionBuffer` contains stereo samples, but it only contains mono samples.

### EngineSimReadAudioBuffer (CORRECT)

**File**: engine-sim-bridge/src/engine_sim_bridge.cpp:618-622

```cpp
for (int i = 0; i < samplesRead; ++i) {
    const float sample = static_cast<float>(ctx->audioConversionBuffer[i]) * scale;
    buffer[i * 2] = sample;     // Left channel
    buffer[i * 2 + 1] = sample; // Right channel
}
```

**Correct**: Properly converts mono to stereo by duplicating each sample.

## Conclusion

The CLI does **NOT** match the GUI's audio configuration:

1. **Input buffer is 43x smaller** (1024 vs 44100 samples)
2. **Input buffer duration is 48x shorter** (21ms vs 1000ms)
3. **Timing margin is 200x smaller** (4.7ms vs 983.4ms)
4. **Uses wrong function** (EngineSimRender vs EngineSimReadAudioBuffer)
5. **Has stereo conversion bug** (if using EngineSimRender)

The fix is to match the GUI's configuration:
```cpp
config.inputBufferSize = config.sampleRate;  // 48000
config.audioBufferSize = config.sampleRate;  // 48000
```

This provides the same 1:1 ratio and 1-second buffer duration as the GUI.
